╔════════════════════════════════════════════════════════════════╗
║  🔐 QUICK FIX: MongoDB Authentication Failed                  ║
╚════════════════════════════════════════════════════════════════╝

❌ ERROR: "bad auth : authentication failed"

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🎯 NGUYÊN NHÂN:
  → Username/Password SAI
  → Hoặc Vercel chưa có MONGODB_URI

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✅ CÁCH SỬA NHANH (3 PHÚT):

┌────────────────────────────────────────────────────────────────┐
│ STEP 1: Test local                                             │
└────────────────────────────────────────────────────────────────┘

  Run:  check-mongodb-auth.bat

  Hoặc:  node test-mongodb-connection.js

  → Nếu PASS: Đi đến STEP 3 (fix Vercel)
  → Nếu FAIL: Đi đến STEP 2 (fix MongoDB)

┌────────────────────────────────────────────────────────────────┐
│ STEP 2: Fix MongoDB Credentials (nếu local FAIL)              │
└────────────────────────────────────────────────────────────────┘

  1. Vào: https://cloud.mongodb.com/
  
  2. Database Access → Add New Database User
     • Username: hrapp_user
     • Password: [Auto-generate & COPY!]
     • Role: Read and write to any database
     • Click "Add User"
  
  3. Clusters → Connect → Connect your application
     • Copy connection string
     • Thay <password> bằng password vừa copy
     • Thêm /humandb trước dấu ?
     
     Result:
     mongodb+srv://hrapp_user:PASSWORD@cluster.net/humandb?retryWrites=true&w=majority
  
  4. Edit: backend\config.env
     MONGODB_URI=mongodb+srv://hrapp_user:PASSWORD@...
  
  5. Test lại: node test-mongodb-connection.js

┌────────────────────────────────────────────────────────────────┐
│ STEP 3: Fix Vercel Environment Variables                      │
└────────────────────────────────────────────────────────────────┘

  1. Copy MONGODB_URI từ backend\config.env
     
     Command: type backend\config.env | findstr MONGODB_URI
  
  2. Vercel Dashboard → Project → Settings → Environment Variables
  
  3. Remove MONGODB_URI cũ (nếu có)
  
  4. Add New:
     ┌─────────────────────────────────────────────────────────┐
     │ Name: MONGODB_URI                                       │
     │ Value: [Paste URI từ step 1]                           │
     │ Environment:                                            │
     │   ☑ Production                                          │
     │   ☑ Preview                                             │
     │   ☑ Development                                         │
     └─────────────────────────────────────────────────────────┘
     Click "Save"
  
  5. Redeploy:
     Deployments → Latest → "..." → Redeploy

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

🔍 VERIFY (sau khi fix):

  curl https://your-app.vercel.app/api/health

  Expected:
  {
    "success": true,
    "dbStatus": "connected",    ← MUST BE "connected"
    "envCheck": {
      "mongodbUri": true         ← MUST BE true
    }
  }

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

⚠️  COMMON MISTAKES:

  ❌ Password có ký tự đặc biệt chưa encode
     Fix: Dùng password đơn giản hoặc URL encode (@→%40, :→%3A)
  
  ❌ Thiếu database name trong URI
     Fix: Thêm /humandb trước dấu ?
  
  ❌ Copy/paste có khoảng trắng
     Fix: Xóa khoảng trắng đầu/cuối
  
  ❌ Set env var nhưng quên redeploy
     Fix: PHẢI redeploy sau khi đổi env vars

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

📖 DETAILED DOCS:
  → FIX_MONGODB_AUTH_ERROR.md
  → Run: check-mongodb-auth.bat (auto-check)

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

✨ TL;DR:

  1. Run: check-mongodb-auth.bat
  2. If local OK → Copy URI to Vercel env vars
  3. If local FAIL → Create new MongoDB user
  4. Redeploy Vercel
  5. Done!

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

Need help? Check logs:
  vercel logs --prod


